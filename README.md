# Uterus-tracking
> Проект посвящен разработке метода динамической привязки 3D-модели органа к видеопотоку. При этом необходимо учитывать смещение/вращение эндоскопа, движение органа и его деформацию.

## Архитектура решения
- Разделение видеопотока на кадры
- Сегментация органа на изображении
- Использование модели глубины для создания облака точек
- Деформация модели по облаку точек
- Сопоставление модели органа с изображением
- Создание видеопотока с привязанной моделью органа

## Сегментация органа
> Для сегментации органа была использована модель Yolo11m-seg, обученная на 1040 изображениях матки, предварительно размеченных с помощью онлайн-ресурса cvat.ai.

## Модель глубины для создания облака точек
> Для перевода полученного облака точек из системы координат камеры в мировые координаты была использована матрица камеры со следующими параметрами:

$$Matrix_{camera} =\begin{bmatrix} f_x & 0 & 0 \\\ 0 & f_y & 0 \\\ 0 & 0 & 1 \end{bmatrix}$$

$$f_x = \frac{f*w}{W}$$ 

$$f_y = \dfrac{f*h}{H}$$

f - фокусное расстояние (25 мм), w и h - размеры кадра (w = 1280, h = 720), W и H - размеры матрицы (W = 7.28 мм, H = 4.37 мм)

## Деформация модели
>С помощью библиотеки probreg была выполнена деформация предоставленной 3D модели методом гибкой деформации (Non-rigid transformation – Affine deformation). 
>Использование аффинных преобразований обусловлено сохранением общей геометрии модели (формы), при этом происходит её смещение и масштабирование.

## Сопоставление 3D-модели с изображением.
>Полученное деформированное облако точек модели было переведено в координаты камеры с помощью обратной матрицы камеры. Полученное облако точек было преобразовано в 3D-сетчатую модель.
>Были найдены точки вершин сетчатой модели, координаты вершин треугольников, создающих модель, и отрисованы линии между вершинами треугольников на изображении.

